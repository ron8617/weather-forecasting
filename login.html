<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <title>Weather App - Secure Authentication</title>
    <style>


        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: #333;
        }
        
        .auth-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 350px;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .auth-form {
            transition: all 0.3s ease;
        }
        
        .auth-form h2 {
            margin-bottom: 30px;
            color: #444;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #6e8efb;
        }
        
        button {
            background-color: #6e8efb;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        
        button:hover {
            background-color: #5a7de3;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .toggle-auth {
            margin-top: 20px;
            font-size: 14px;
        }
        
        .toggle-auth a {
            color: #6e8efb;
            text-decoration: none;
            cursor: pointer;
            font-weight: 500;
        }
        
        .weather-logo {
            width: 80px;
            margin-bottom: 20px;
        }
        
        /* Animation for form switching */
        #loginForm {
            opacity: 1;
            transform: translateX(0);
        }
        
        #signupForm {
            position: absolute;
            top: 40px;
            left: 40px;
            right: 40px;
            opacity: 0;
            transform: translateX(100%);
        }
        
        .show-signup #loginForm {
            opacity: 0;
            transform: translateX(-100%);
        }
        
        .show-signup #signupForm {
            opacity: 1;
            transform: translateX(0);
        }
        
        .error-message {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        
        .success-message {
            color: #2ecc71;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .password-strength {
            margin-top: 5px;
            height: 5px;
            background-color: #eee;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .strength-meter {
            height: 100%;
            width: 0;
            transition: width 0.3s, background-color 0.3s;
        }
        
        .password-hint {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            display: none;
        }
    </style>
</head>
<body>







    <div class="auth-container" id="authContainer">
        <img src="weather-icon.png" alt="Weather Logo" class="weather-logo">
        
        <!-- Login Form -->
        <form id="loginForm" class="auth-form">
            <h2>Welcome Back!</h2>
            
            <input type="hidden" id="login-csrf" name="csrf_token">
            
            <div class="form-group">
                <label for="login-username">Username or Email</label>
                <input type="text" id="login-username" name="username" required autocomplete="username">
                <div class="error-message" id="login-username-error"></div>
            </div>
            
            <div class="form-group">
                <label for="login-password">Password</label>
                <input type="password" id="login-password" name="password" required autocomplete="current-password">
                <div class="error-message" id="login-password-error"></div>
            </div>
            
            <button type="submit" id="loginButton">
                <span id="loginButtonText">Login</span>
                <span id="loginButtonSpinner" class="loading" style="display: none;"></span>
            </button>
            
            <div class="toggle-auth">
                Don't have an account? <a id="showSignup">Sign up</a>
            </div>
            
            <div class="success-message" id="login-success" style="display: none;">
                Login successful! Redirecting...
            </div>
        </form>
        
        <!-- Signup Form -->
        <form id="signupForm" class="auth-form">
            <h2>Create Account</h2>
            
            <input type="hidden" id="signup-csrf" name="csrf_token">
            
            <div class="form-group">
                <label for="signup-username">Username</label>
                <input type="text" id="signup-username" name="username" required autocomplete="username" minlength="3" maxlength="30" pattern="[a-zA-Z0-9_]+">
                <div class="error-message" id="signup-username-error"></div>
            </div>
            
            <div class="form-group">
                <label for="signup-email">Email</label>
                <input type="email" id="signup-email" name="email" required autocomplete="email">
                <div class="error-message" id="signup-email-error"></div>
            </div>
            
            <div class="form-group">
                <label for="signup-password">Password</label>
                <input type="password" id="signup-password" name="password" required autocomplete="new-password" minlength="8">
                <div class="password-strength">
                    <div class="strength-meter" id="password-strength-meter"></div>
                </div>
                <div class="password-hint" id="password-hint">
                    Password must contain at least 8 characters, including uppercase, lowercase, number, and special character
                </div>
                <div class="error-message" id="signup-password-error"></div>
            </div>
            
            <div class="form-group">
                <label for="signup-confirm-password">Confirm Password</label>
                <input type="password" id="signup-confirm-password" name="confirm-password" required autocomplete="new-password">
                <div class="error-message" id="signup-confirm-error"></div>
            </div>
            
            <button type="submit" id="signupButton">
                <span id="signupButtonText">Sign Up</span>
                <span id="signupButtonSpinner" class="loading" style="display: none;"></span>
            </button>
            
            <div class="toggle-auth">
                Already have an account? <a id="showLogin">Login</a>
            </div>
            
            <div class="success-message" id="signup-success" style="display: none;">
                Account created successfully!
            </div>
        </form>
    </div>

    <script>

    


        
        // Security Configuration
        const SECURITY = {
            SESSION_TIMEOUT: 3600000, // 1 hour in milliseconds
            MAX_LOGIN_ATTEMPTS: 10,    // Changed from 5 to 10 attempts
            LOGIN_TIMEOUT: 300000,     // 5 minutes in milliseconds (5*60*1000)
            PASSWORD_MIN_LENGTH: 8,
            ALLOWED_REDIRECT_PATHS: ['/index.html', '/dashboard.html']
        };

        // DOM Elements
        const authContainer = document.getElementById('authContainer');
        const showSignupBtn = document.getElementById('showSignup');
        const showLoginBtn = document.getElementById('showLogin');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const loginCsrf = document.getElementById('login-csrf');
        const signupCsrf = document.getElementById('signup-csrf');
        
        // Initialize CSRF tokens
        function initializeCSRFTokens() {
            const loginToken = generateCSRFToken();
            const signupToken = generateCSRFToken();
            
            loginCsrf.value = loginToken;
            signupCsrf.value = signupToken;
            
            sessionStorage.setItem('loginCSRFToken', loginToken);
            sessionStorage.setItem('signupCSRFToken', signupToken);
        }
        
        // Generate CSRF token
        function generateCSRFToken() {
            const array = new Uint32Array(5);
            window.crypto.getRandomValues(array);
            return array.join('');
        }
        
        // Initialize the page
        function init() {
            initializeCSRFTokens();
            checkExistingSession();
            setupEventListeners();
            setupPasswordStrengthMeter();
        }
        
        // Check for existing valid session
        function checkExistingSession() {
            const authToken = getAuthToken();
            if (authToken) {
                safeRedirect('/index.html');
            }
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Toggle between login and signup forms
            showSignupBtn.addEventListener('click', function(e) {
                e.preventDefault();
                authContainer.classList.add('show-signup');
                initializeCSRFTokens(); // Refresh tokens when switching forms
            });
            
            showLoginBtn.addEventListener('click', function(e) {
                e.preventDefault();
                authContainer.classList.remove('show-signup');
                initializeCSRFTokens(); // Refresh tokens when switching forms
            });
            
            // Login form submission
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin();
            });
            
            // Signup form submission
            signupForm.addEventListener('submit', function(e) {
                e.preventDefault();
                handleSignup();
            });
            
            // Password strength indicator
            document.getElementById('signup-password').addEventListener('input', updatePasswordStrength);
        }
        
        // Password strength meter
        function setupPasswordStrengthMeter() {
            const passwordInput = document.getElementById('signup-password');
            const hint = document.getElementById('password-hint');
            
            passwordInput.addEventListener('focus', () => {
                hint.style.display = 'block';
            });
            
            passwordInput.addEventListener('blur', () => {
                hint.style.display = 'none';
            });
        }
        
        function updatePasswordStrength() {
            const password = document.getElementById('signup-password').value;
            const meter = document.getElementById('password-strength-meter');
            
            // Calculate strength (0-100)
            let strength = 0;
            
            // Length
            strength += Math.min(password.length * 5, 30);
            
            // Contains uppercase
            if (/[A-Z]/.test(password)) strength += 15;
            
            // Contains lowercase
            if (/[a-z]/.test(password)) strength += 15;
            
            // Contains number
            if (/\d/.test(password)) strength += 15;
            
            // Contains special char
            if (/[^A-Za-z0-9]/.test(password)) strength += 15;
            
            // Repeated characters reduce strength
            if (/(.)\1/.test(password)) strength -= 10;
            
            // Update meter
            strength = Math.max(0, Math.min(100, strength));
            meter.style.width = strength + '%';
            
            // Update color
            if (strength < 30) {
                meter.style.backgroundColor = '#e74c3c';
            } else if (strength < 70) {
                meter.style.backgroundColor = '#f39c12';
            } else {
                meter.style.backgroundColor = '#2ecc71';
            }
        }
        
        // Handle login process
        function handleLogin() {
            clearErrors('login');
            
            // Check rate limiting
            const attempts = localStorage.getItem('loginAttempts') || 0;
            if (attempts >= SECURITY.MAX_LOGIN_ATTEMPTS) {
                showError('login-password-error', `Too many attempts. Please try again in ${Math.ceil(SECURITY.LOGIN_TIMEOUT/60000)} minutes.`);
                return;
            }
            
            // Validate CSRF token
            const csrfToken = loginCsrf.value;
            const storedToken = sessionStorage.getItem('loginCSRFToken');
            
            if (!csrfToken || csrfToken !== storedToken) {
                showError('login-username-error', 'Invalid request. Please refresh the page.');
                return;
            }
            
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();
            
            // Simple validation
            let isValid = true;
            
            if (username === '') {
                showError('login-username-error', 'Username is required');
                isValid = false;
            }
            
            if (password === '') {
                showError('login-password-error', 'Password is required');
                isValid = false;
            }
            
            if (isValid) {
                // Show loading state
                const loginButton = document.getElementById('loginButton');
                const loginButtonText = document.getElementById('loginButtonText');
                const loginButtonSpinner = document.getElementById('loginButtonSpinner');
                
                loginButton.disabled = true;
                loginButtonText.textContent = 'Logging in...';
                loginButtonSpinner.style.display = 'inline-block';
                
                // Simulate API call with timeout (replace with actual API call)
                setTimeout(() => {
                    simulateLogin(username, password);
                }, 1500);
            }
        }
        
        // Simulate login function (replace with actual API call)
        function simulateLogin(username, password) {
            const loginButton = document.getElementById('loginButton');
            const loginButtonText = document.getElementById('loginButtonText');
            const loginButtonSpinner = document.getElementById('loginButtonSpinner');
            const loginSuccessMessage = document.getElementById('login-success');
            
            // For demo purposes, we'll check against stored credentials
            const storedUser = localStorage.getItem('weatherAppUser');
            
            if (storedUser) {
                const user = JSON.parse(storedUser);
                
                // Check credentials (case-sensitive)
                if ((username === user.username || username === user.email) && password === user.password) {
                    // Show success message
                    loginSuccessMessage.style.display = 'block';
                    
                    // Hide loading state
                    loginButtonText.textContent = 'Login';
                    loginButtonSpinner.style.display = 'none';
                    
                    // Create auth token
                    const authToken = generateAuthToken(username);
                    setAuthToken(authToken);
                    
                    // Clear login attempts
                    localStorage.removeItem('loginAttempts');
                    
                    // Redirect after 1 second
                    setTimeout(() => {
                        safeRedirect('/index.html');
                    }, 1000);
                    return;
                }
            }
            
            // If we get here, login failed
            showError('login-password-error', 'Invalid username or password');
            loginButton.disabled = false;
            loginButtonText.textContent = 'Login';
            loginButtonSpinner.style.display = 'none';
            
            // Increment failed attempts
            const attempts = localStorage.getItem('loginAttempts') || 0;
            localStorage.setItem('loginAttempts', parseInt(attempts) + 1);
            
            // Lock after max attempts
            if (attempts >= SECURITY.MAX_LOGIN_ATTEMPTS - 1) {
                setTimeout(() => {
                    localStorage.removeItem('loginAttempts');
                }, SECURITY.LOGIN_TIMEOUT);
            }
        }
        
        // Handle signup process
        function handleSignup() {
            clearErrors('signup');
            
            // Validate CSRF token
            const csrfToken = signupCsrf.value;
            const storedToken = sessionStorage.getItem('signupCSRFToken');
            
            if (!csrfToken || csrfToken !== storedToken) {
                showError('signup-username-error', 'Invalid request. Please refresh the page.');
                return;
            }
            
            const username = document.getElementById('signup-username').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-confirm-password').value;
            
            // Validation
            let isValid = true;
            
            if (username === '') {
                showError('signup-username-error', 'Username is required');
                isValid = false;
            } else if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                showError('signup-username-error', 'Username can only contain letters, numbers, and underscores');
                isValid = false;
            } else if (username.length < 3) {
                showError('signup-username-error', 'Username must be at least 3 characters');
                isValid = false;
            }
            
            if (email === '') {
                showError('signup-email-error', 'Email is required');
                isValid = false;
            } else if (!validateEmail(email)) {
                showError('signup-email-error', 'Please enter a valid email');
                isValid = false;
            }
            
            if (password === '') {
                showError('signup-password-error', 'Password is required');
                isValid = false;
            } else if (password.length < SECURITY.PASSWORD_MIN_LENGTH) {
                showError('signup-password-error', `Password must be at least ${SECURITY.PASSWORD_MIN_LENGTH} characters`);
                isValid = false;
            } else if (!validatePasswordStrength(password)) {
                showError('signup-password-error', 'Password must include uppercase, lowercase, number, and special character');
                isValid = false;
            }
            
            if (confirmPassword === '') {
                showError('signup-confirm-error', 'Please confirm your password');
                isValid = false;
            } else if (password !== confirmPassword) {
                showError('signup-confirm-error', 'Passwords do not match');
                isValid = false;
            }
            
            if (isValid) {
                // Show loading state
                const signupButton = document.getElementById('signupButton');
                const signupButtonText = document.getElementById('signupButtonText');
                const signupButtonSpinner = document.getElementById('signupButtonSpinner');
                const signupSuccessMessage = document.getElementById('signup-success');
                
                signupButton.disabled = true;
                signupButtonText.textContent = 'Creating account...';
                signupButtonSpinner.style.display = 'inline-block';
                
                // Simulate API call with timeout (replace with actual API call)
                setTimeout(() => {
                    // Store user data (in a real app, this would be a server call)
                    const userData = {
                        username: username,
                        email: email,
                        password: password // In a real app, NEVER store plain text passwords
                    };
                    
                    localStorage.setItem('weatherAppUser', JSON.stringify(userData));
                    
                    // Show success message
                    signupSuccessMessage.style.display = 'block';
                    
                    // Reset form
                    signupButton.disabled = false;
                    signupButtonText.textContent = 'Sign Up';
                    signupButtonSpinner.style.display = 'none';
                    
                    // Switch back to login form after 2 seconds
                    setTimeout(() => {
                        authContainer.classList.remove('show-signup');
                        signupForm.reset();
                        signupSuccessMessage.style.display = 'none';
                        document.getElementById('password-strength-meter').style.width = '0';
                    }, 2000);
                }, 1500);
            }
        }
        
        // Security helper functions
        function generateAuthToken(username) {
            const tokenData = {
                username: username,
                created: Date.now(),
                expires: Date.now() + SECURITY.SESSION_TIMEOUT,
                random: window.crypto.getRandomValues(new Uint32Array(1))[0].toString(16)
            };
            return btoa(JSON.stringify(tokenData));
        }
        
        function setAuthToken(token) {
            sessionStorage.setItem('authToken', token);
        }
        
        function getAuthToken() {
            const token = sessionStorage.getItem('authToken');
            if (!token) return null;
            
            try {
                const tokenData = JSON.parse(atob(token));
                if (tokenData.expires > Date.now()) {
                    return tokenData;
                }
                sessionStorage.removeItem('authToken');
            } catch (e) {
                sessionStorage.removeItem('authToken');
            }
            return null;
        }
        
        function safeRedirect(path) {
            // Validate the path
            if (!SECURITY.ALLOWED_REDIRECT_PATHS.includes(path)) {
                path = '/index.html'; // default fallback
            }
            
            // Construct full URL
            const baseUrl = window.location.protocol + '//' + 
                           window.location.hostname + 
                           (window.location.port ? ':' + window.location.port : '');
            
            // Perform redirect
            window.location.href = baseUrl + path;
        }
        
        // Validation helper functions
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
        }
        
        function clearErrors(formType) {
            const errorElements = document.querySelectorAll(`#${formType}Form .error-message`);
            errorElements.forEach(element => {
                element.textContent = '';
                element.style.display = 'none';
            });
        }
        
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }
        
        function validatePasswordStrength(password) {
            const hasUpper = /[A-Z]/.test(password);
            const hasLower = /[a-z]/.test(password);
            const hasNumber = /\d/.test(password);
            const hasSpecial = /[^A-Za-z0-9]/.test(password);
            
            return password.length >= SECURITY.PASSWORD_MIN_LENGTH && 
                   hasUpper && 
                   hasLower && 
                   hasNumber && 
                   hasSpecial;
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>